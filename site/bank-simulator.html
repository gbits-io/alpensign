<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Big Bank 123 ‚Äî Client Portal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --navy: #0a1628;
  --navy-light: #132040;
  --navy-mid: #1a2d54;
  --slate: #334766;
  --steel: #8899b0;
  --silver: #c4cfde;
  --cream: #e8ecf2;
  --white: #f5f7fa;
  --gold: #d4a843;
  --gold-dim: rgba(212, 168, 67, 0.15);
  --gold-glow: rgba(212, 168, 67, 0.3);
  --green: #34d399;
  --green-dim: rgba(52, 211, 153, 0.12);
  --green-glow: rgba(52, 211, 153, 0.25);
  --red: #f87171;
  --red-dim: rgba(248, 113, 113, 0.12);
  --blue: #60a5fa;
  --blue-dim: rgba(96, 165, 250, 0.12);
  --orange: #fb923c;
  --orange-dim: rgba(251, 146, 60, 0.12);
  --font: 'DM Sans', -apple-system, sans-serif;
  --mono: 'JetBrains Mono', monospace;
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 2px 12px rgba(0,0,0,0.3);
}

html, body {
  height: 100%;
  font-family: var(--font);
  background: var(--navy);
  color: var(--cream);
  -webkit-font-smoothing: antialiased;
  overflow: hidden;
}

/* ‚ïê‚ïê‚ïê APP SHELL ‚ïê‚ïê‚ïê */
.app {
  display: flex;
  flex-direction: column;
  height: 100dvh;
  max-width: 480px;
  margin: 0 auto;
  position: relative;
  overflow: hidden;
}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.header {
  padding: 16px 20px 12px;
  background: linear-gradient(180deg, var(--navy) 0%, var(--navy-light) 100%);
  border-bottom: 1px solid rgba(212, 168, 67, 0.12);
  flex-shrink: 0;
  position: relative;
  z-index: 10;
}

.header-top {
  display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
}

.bank-shield {
  width: 40px; height: 40px;
  background: linear-gradient(135deg, var(--gold) 0%, #b8922e 100%);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 700; color: var(--navy);
  box-shadow: 0 2px 8px rgba(212, 168, 67, 0.3);
  letter-spacing: -0.5px;
}

.bank-name {
  font-size: 17px; font-weight: 600; color: var(--white);
  letter-spacing: 0.3px;
}

.bank-subtitle {
  font-size: 11px; color: var(--steel);
  letter-spacing: 0.8px; text-transform: uppercase;
  margin-top: 1px;
}

.env-badge {
  margin-left: auto;
  padding: 3px 8px;
  background: var(--orange-dim);
  color: var(--orange);
  font-size: 10px; font-weight: 600;
  border-radius: 4px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

/* ‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê */
.tabs {
  display: flex; gap: 4px;
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
  padding: 3px;
}

.tab {
  flex: 1;
  padding: 9px 0;
  text-align: center;
  font-size: 13px;
  font-weight: 500;
  color: var(--steel);
  border: none;
  background: transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.25s ease;
  font-family: var(--font);
  letter-spacing: 0.2px;
}

.tab.active {
  background: var(--navy-mid);
  color: var(--gold);
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}

.tab:not(.active):hover { color: var(--silver); }

/* ‚ïê‚ïê‚ïê CONTENT ‚ïê‚ïê‚ïê */
.content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 20px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}

.content::-webkit-scrollbar { display: none; }

.view { display: none; }
.view.active { display: block; animation: fadeSlide 0.3s ease; }

@keyframes fadeSlide {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ‚ïê‚ïê‚ïê SECTION CARD ‚ïê‚ïê‚ïê */
.card {
  background: var(--navy-light);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
}

.card-header {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 16px;
}

.card-icon {
  width: 32px; height: 32px;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px;
  flex-shrink: 0;
}

.card-icon.gold { background: var(--gold-dim); }
.card-icon.green { background: var(--green-dim); }
.card-icon.blue { background: var(--blue-dim); }
.card-icon.red { background: var(--red-dim); }

.card-title {
  font-size: 14px; font-weight: 600; color: var(--white);
  letter-spacing: 0.2px;
}

.card-desc {
  font-size: 12px; color: var(--steel); margin-top: 2px;
  line-height: 1.4;
}

/* ‚ïê‚ïê‚ïê FORM FIELDS ‚ïê‚ïê‚ïê */
.field { margin-bottom: 16px; }

.field-label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  color: var(--steel);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 6px;
}

.field-static {
  font-size: 15px;
  font-weight: 500;
  color: var(--white);
  padding: 12px 14px;
  background: rgba(0,0,0,0.2);
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255,255,255,0.04);
}

.field-static.mono {
  font-family: var(--mono);
  font-size: 12px;
  letter-spacing: 0.3px;
  word-break: break-all;
  line-height: 1.5;
  color: var(--silver);
}

.field-input {
  width: 100%;
  font-size: 15px;
  font-weight: 500;
  color: var(--white);
  padding: 12px 14px;
  background: rgba(0,0,0,0.25);
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255,255,255,0.08);
  font-family: var(--font);
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.field-input::placeholder { color: var(--slate); }

.field-input:focus {
  border-color: var(--gold);
  box-shadow: 0 0 0 3px var(--gold-dim);
}

.field-input.mono {
  font-family: var(--mono);
  font-size: 13px;
  letter-spacing: 0.3px;
}

.field-input.error {
  border-color: var(--red);
  box-shadow: 0 0 0 3px var(--red-dim);
}

.field-hint {
  font-size: 11px; color: var(--slate);
  margin-top: 5px; line-height: 1.4;
}

.field-error {
  font-size: 11px; color: var(--red);
  margin-top: 5px;
}

/* ‚ïê‚ïê‚ïê STATUS ROW ‚ïê‚ïê‚ïê */
.status-row {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px;
  background: rgba(0,0,0,0.15);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
}

.status-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-dot.pending { background: var(--orange); box-shadow: 0 0 6px var(--orange); }
.status-dot.active { background: var(--green); box-shadow: 0 0 6px var(--green); }
.status-dot.inactive { background: var(--slate); }
.status-dot.error { background: var(--red); box-shadow: 0 0 6px var(--red); }

.status-label {
  font-size: 12px; color: var(--steel); flex: 1;
}

.status-value {
  font-size: 12px; font-weight: 600;
  font-family: var(--mono);
}

.status-value.green { color: var(--green); }
.status-value.orange { color: var(--orange); }
.status-value.red { color: var(--red); }
.status-value.steel { color: var(--steel); }

/* ‚ïê‚ïê‚ïê CHALLENGE STRING ‚ïê‚ïê‚ïê */
.challenge-box {
  background: rgba(0,0,0,0.3);
  border: 1px dashed rgba(212, 168, 67, 0.25);
  border-radius: var(--radius-sm);
  padding: 14px;
  text-align: center;
  margin-bottom: 4px;
}

.challenge-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--gold);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
}

.challenge-string {
  font-family: var(--mono);
  font-size: 16px;
  font-weight: 500;
  color: var(--white);
  letter-spacing: 2px;
  user-select: all;
}

.challenge-hint {
  font-size: 10px;
  color: var(--slate);
  margin-top: 8px;
  line-height: 1.4;
}

/* ‚ïê‚ïê‚ïê BUTTONS ‚ïê‚ïê‚ïê */
.btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%;
  padding: 14px 20px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: var(--font);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  letter-spacing: 0.3px;
}

.btn-gold {
  background: linear-gradient(135deg, var(--gold) 0%, #c49a38 100%);
  color: var(--navy);
  box-shadow: 0 2px 10px rgba(212, 168, 67, 0.3);
}

.btn-gold:hover { box-shadow: 0 4px 16px rgba(212, 168, 67, 0.4); transform: translateY(-1px); }
.btn-gold:active { transform: translateY(0); }

.btn-gold:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-outline {
  background: transparent;
  color: var(--gold);
  border: 1px solid rgba(212, 168, 67, 0.3);
}

.btn-outline:hover { background: var(--gold-dim); }

.btn-danger {
  background: transparent;
  color: var(--red);
  border: 1px solid rgba(248, 113, 113, 0.2);
}

.btn-danger:hover { background: var(--red-dim); }

.btn-send {
  background: linear-gradient(135deg, var(--green) 0%, #22b07a 100%);
  color: var(--navy);
  box-shadow: 0 2px 10px rgba(52, 211, 153, 0.3);
}

.btn-send:hover { box-shadow: 0 4px 16px rgba(52, 211, 153, 0.4); transform: translateY(-1px); }
.btn-send:active { transform: translateY(0); }
.btn-send:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

/* ‚ïê‚ïê‚ïê DIVIDER ‚ïê‚ïê‚ïê */
.divider {
  height: 1px;
  background: rgba(255,255,255,0.06);
  margin: 16px 0;
}

/* ‚ïê‚ïê‚ïê TIMELINE ‚ïê‚ïê‚ïê */
.timeline { padding: 0; }

.timeline-step {
  display: flex; gap: 14px;
  padding-bottom: 20px;
  position: relative;
}

.timeline-step:last-child { padding-bottom: 0; }

.timeline-step::before {
  content: '';
  position: absolute;
  left: 15px; top: 32px;
  bottom: 0;
  width: 1px;
  background: rgba(255,255,255,0.06);
}

.timeline-step:last-child::before { display: none; }

.timeline-num {
  width: 30px; height: 30px;
  border-radius: 50%;
  background: var(--navy-mid);
  border: 1px solid rgba(255,255,255,0.08);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 600; color: var(--steel);
  flex-shrink: 0;
  z-index: 1;
  transition: all 0.3s ease;
}

.timeline-step.done .timeline-num {
  background: var(--green-dim);
  border-color: var(--green);
  color: var(--green);
}

.timeline-step.active .timeline-num {
  background: var(--gold-dim);
  border-color: var(--gold);
  color: var(--gold);
  box-shadow: 0 0 8px var(--gold-dim);
}

.timeline-body { flex: 1; padding-top: 4px; }

.timeline-title {
  font-size: 13px; font-weight: 600; color: var(--white);
  margin-bottom: 3px;
}

.timeline-desc {
  font-size: 11px; color: var(--steel); line-height: 1.5;
}

/* ‚ïê‚ïê‚ïê PAYMENT SUMMARY ‚ïê‚ïê‚ïê */
.payment-hero {
  text-align: center;
  padding: 24px 0 20px;
}

.payment-amount {
  font-size: 36px;
  font-weight: 700;
  color: var(--white);
  letter-spacing: -0.5px;
}

.payment-currency {
  font-size: 16px;
  font-weight: 400;
  color: var(--steel);
}

.payment-type-badge {
  display: inline-block;
  padding: 4px 10px;
  background: var(--red-dim);
  color: var(--red);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  border-radius: 4px;
  margin-top: 8px;
}

.payment-type-badge.sic {
  background: var(--blue-dim);
  color: var(--blue);
}

/* ‚ïê‚ïê‚ïê KV TABLE ‚ïê‚ïê‚ïê */
.kv-table { width: 100%; }

.kv-row {
  display: flex;
  padding: 10px 0;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}

.kv-row:last-child { border-bottom: none; }

.kv-key {
  font-size: 12px; color: var(--steel);
  width: 110px; flex-shrink: 0;
  padding-top: 1px;
}

.kv-val {
  font-size: 13px; color: var(--white); font-weight: 500;
  flex: 1;
  word-break: break-word;
}

.kv-val.mono {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--silver);
  letter-spacing: 0.2px;
}

/* ‚ïê‚ïê‚ïê SEAL STATUS BANNER ‚ïê‚ïê‚ïê */
.seal-banner {
  display: none;
  padding: 14px 16px;
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
  animation: fadeSlide 0.4s ease;
}

.seal-banner.waiting {
  display: flex;
  background: var(--orange-dim);
  border: 1px solid rgba(251, 146, 60, 0.2);
  align-items: center; gap: 10px;
}

.seal-banner.sealed {
  display: flex;
  background: var(--green-dim);
  border: 1px solid rgba(52, 211, 153, 0.2);
  align-items: center; gap: 10px;
}

.seal-banner-icon { font-size: 18px; flex-shrink: 0; }

.seal-banner-text {
  font-size: 12px; font-weight: 500; line-height: 1.4;
}

.seal-banner.waiting .seal-banner-text { color: var(--orange); }
.seal-banner.sealed .seal-banner-text { color: var(--green); }

/* ‚ïê‚ïê‚ïê SPINNER ‚ïê‚ïê‚ïê */
@keyframes spin { to { transform: rotate(360deg); } }

.spinner {
  width: 16px; height: 16px;
  border: 2px solid rgba(212, 168, 67, 0.2);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  flex-shrink: 0;
}

.spinner.green {
  border-color: rgba(52, 211, 153, 0.2);
  border-top-color: var(--green);
}

/* ‚ïê‚ïê‚ïê PULSE ‚ïê‚ïê‚ïê */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
.pulse { animation: pulse 2s ease-in-out infinite; }

/* ‚ïê‚ïê‚ïê FOOTER ‚ïê‚ïê‚ïê */
.footer {
  padding: 12px 20px;
  text-align: center;
  font-size: 10px;
  color: var(--slate);
  border-top: 1px solid rgba(255,255,255,0.04);
  flex-shrink: 0;
  letter-spacing: 0.3px;
}

.footer a { color: var(--steel); text-decoration: none; }
.footer a:hover { color: var(--gold); }

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%; transform: translateX(-50%) translateY(20px);
  padding: 12px 20px;
  background: var(--navy-mid);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius);
  font-size: 13px; font-weight: 500; color: var(--white);
  box-shadow: var(--shadow);
  opacity: 0;
  transition: all 0.3s ease;
  pointer-events: none;
  z-index: 100;
  max-width: 320px;
  text-align: center;
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* ‚ïê‚ïê‚ïê DEVICE MODE SELECTOR ‚ïê‚ïê‚ïê */
.mode-selector {
  display: flex; gap: 4px;
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
  padding: 3px;
  margin-bottom: 20px;
}

.mode-btn {
  flex: 1;
  padding: 10px 8px;
  text-align: center;
  font-size: 12px;
  font-weight: 500;
  color: var(--steel);
  border: none;
  background: transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.25s ease;
  font-family: var(--font);
  line-height: 1.3;
}

.mode-btn.active {
  background: var(--navy-mid);
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}

.mode-btn.active.seeker-mode { color: var(--green); }
.mode-btn.active.generic-mode { color: var(--orange); }

.mode-btn:not(.active):hover { color: var(--silver); }

.mode-label { display: block; font-weight: 600; font-size: 13px; }
.mode-sub { display: block; font-size: 10px; opacity: 0.7; margin-top: 2px; }

/* ‚ïê‚ïê‚ïê TRUST COMPARISON ‚ïê‚ïê‚ïê */
.trust-comparison {
  border-radius: var(--radius-sm);
  overflow: hidden;
  margin-bottom: 16px;
}

.trust-row {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 10px 12px;
  background: rgba(0,0,0,0.1);
  border-bottom: 1px solid rgba(255,255,255,0.03);
}

.trust-row:last-child { border-bottom: none; }

.trust-icon {
  flex-shrink: 0;
  font-size: 14px;
  width: 20px;
  text-align: center;
  margin-top: 1px;
}

.trust-body { flex: 1; }

.trust-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--white);
  line-height: 1.3;
}

.trust-desc {
  font-size: 10.5px;
  color: var(--steel);
  line-height: 1.4;
  margin-top: 2px;
}

.trust-row.missing { background: rgba(251, 146, 60, 0.06); }
.trust-row.missing .trust-label { color: var(--orange); }
.trust-row.present .trust-label { color: var(--green); }

/* ‚ïê‚ïê‚ïê GENERIC ATTESTATION ‚ïê‚ïê‚ïê */
.generic-attestation-card {
  background: rgba(0,0,0,0.2);
  border: 1px solid rgba(251, 146, 60, 0.15);
  border-radius: var(--radius-sm);
  padding: 16px;
  margin-top: 12px;
}

.generic-attestation-badge {
  padding: 3px 8px;
  background: var(--orange-dim);
  color: var(--orange);
  font-size: 10px;
  font-weight: 600;
  border-radius: 4px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

/* ‚ïê‚ïê‚ïê CONNECTION LINE (decorative) ‚ïê‚ïê‚ïê */
.connection-line {
  display: flex; align-items: center; gap: 8px;
  padding: 12px 0;
  opacity: 0.5;
}

.connection-line .dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--gold);
}

.connection-line .line {
  flex: 1;
  height: 1px;
  background: repeating-linear-gradient(90deg, var(--gold) 0px, var(--gold) 4px, transparent 4px, transparent 8px);
}

/* ‚ïê‚ïê‚ïê ATTESTATION VISUAL ‚ïê‚ïê‚ïê */
.attestation-card {
  background: rgba(0,0,0,0.2);
  border: 1px solid rgba(52, 211, 153, 0.15);
  border-radius: var(--radius-sm);
  padding: 16px;
  margin-top: 12px;
}

.attestation-header {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 12px;
}

.attestation-badge {
  padding: 3px 8px;
  background: var(--green-dim);
  color: var(--green);
  font-size: 10px;
  font-weight: 600;
  border-radius: 4px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.attestation-schema {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--slate);
  margin-left: auto;
}
</style>
</head>
<body>

<div class="app">
  <!-- HEADER -->
  <div class="header">
    <div class="header-top">
      <div class="bank-shield">B</div>
      <div>
        <div class="bank-name">Big Bank 123</div>
        <div class="bank-subtitle">Client Portal ¬∑ Seeker Integration</div>
      </div>
      <div class="env-badge">Demo</div>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="pairing" onclick="switchTab('pairing')">üîó Pairing</button>
      <button class="tab" data-tab="payment" onclick="switchTab('payment')">üí∏ SIC Payment</button>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- ‚ïê‚ïê‚ïê PAIRING VIEW ‚ïê‚ïê‚ïê -->
    <div class="view active" id="view-pairing">

      <!-- Client Identity -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon gold">üè¶</div>
          <div>
            <div class="card-title">Client Relationship</div>
            <div class="card-desc">Bank-side data for this client contract</div>
          </div>
        </div>
        <div class="field">
          <span class="field-label">Bank</span>
          <div class="field-static">Big Bank 123 ¬∑ Z√ºrich</div>
        </div>
        <div class="field">
          <span class="field-label">Contract Number</span>
          <div class="field-static mono">KB-2026-004871</div>
        </div>
        <div class="field">
          <span class="field-label">Client Name</span>
          <div class="field-static">Roman Koivu</div>
        </div>
        <div class="field" style="margin-bottom:0">
          <span class="field-label">Account (IBAN)</span>
          <div class="field-static mono">CH93 0076 2011 6238 5295 7</div>
        </div>
      </div>

      <!-- Device Mode Selector -->
      <div class="mode-selector">
        <button class="mode-btn seeker-mode active" data-mode="seeker" onclick="switchPairingMode('seeker')">
          <span class="mode-label">üì± Solana Seeker</span>
          <span class="mode-sub">Full trust chain</span>
        </button>
        <button class="mode-btn generic-mode" data-mode="generic" onclick="switchPairingMode('generic')">
          <span class="mode-label">üì± Generic Android</span>
          <span class="mode-sub">Reduced trust (demo)</span>
        </button>
      </div>

      <!-- ‚ïê‚ïê‚ïê GENERIC DEVICE PAIRING (Pixel, Samsung, etc.) ‚ïê‚ïê‚ïê -->
      <div id="generic-pairing" style="display:none">

        <!-- Trust Comparison -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon red">‚ö†</div>
            <div>
              <div class="card-title">Reduced Trust Mode</div>
              <div class="card-desc">Generic Android device ‚Äî five trust layers unavailable</div>
            </div>
          </div>

          <div class="trust-comparison">
            <div class="trust-row missing">
              <div class="trust-icon">‚úó</div>
              <div class="trust-body">
                <div class="trust-label">No Genesis Token (SGT)</div>
                <div class="trust-desc">Cannot prove the device is genuine, unrooted hardware. Without the soulbound NFT verified by SKR-staked Guardians via TEEPIN, the phone could be a rooted device, emulator, or compromised.</div>
              </div>
            </div>
            <div class="trust-row missing">
              <div class="trust-icon">‚úó</div>
              <div class="trust-body">
                <div class="trust-label">No SAS Credential (Bank‚ÄìClient binding)</div>
                <div class="trust-desc">No on-chain attestation linking this client to a verified device. The bank cannot issue a revocable Solana Attestation Service credential without a device identity anchor.</div>
              </div>
            </div>
            <div class="trust-row missing">
              <div class="trust-icon">‚úó</div>
              <div class="trust-body">
                <div class="trust-label">No .skr Name (Hardware Identity)</div>
                <div class="trust-desc">No Seeker ID means no implicit proof of TEE-backed key generation, no Guardian attestation chain, and no human-readable device identifier resolvable on Solana.</div>
              </div>
            </div>
            <div class="trust-row missing">
              <div class="trust-icon">‚úó</div>
              <div class="trust-body">
                <div class="trust-label">No Immutable Audit Trail</div>
                <div class="trust-desc">Without Seed Vault, seals cannot be posted to Solana. Payment authorizations exist only as local cryptographic proofs ‚Äî no independent, immutable on-chain record for dispute resolution.</div>
              </div>
            </div>
            <div class="trust-row missing">
              <div class="trust-icon">‚úó</div>
              <div class="trust-body">
                <div class="trust-label">No Seed Vault Signing</div>
                <div class="trust-desc">Signatures use Android's standard WebAuthn keystore, not the Seeker's dedicated secure element. Keys may be extractable on rooted devices. No hardware-level non-exportability guarantee.</div>
              </div>
            </div>
            <div class="trust-row present">
              <div class="trust-icon">‚úì</div>
              <div class="trust-body">
                <div class="trust-label">Biometric-Gated Local Signature</div>
                <div class="trust-desc">WebAuthn ECDSA signature with biometric confirmation is still available. The client can still review and cryptographically sign payment details ‚Äî but proof stays on-device only.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Generic Device Input -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon blue">üì±</div>
            <div>
              <div class="card-title">Link Generic Device</div>
              <div class="card-desc">Enter a device identifier for this client's Android phone</div>
            </div>
          </div>

          <div class="field">
            <span class="field-label">Device Name</span>
            <input type="text" class="field-input" id="generic-device-input" 
                   placeholder="e.g. Pixel 8a, Galaxy S24" 
                   autocapitalize="words" autocorrect="off">
            <div class="field-hint">The client's Android phone model</div>
            <div class="field-error" id="generic-device-error" style="display:none"></div>
          </div>

          <button class="btn btn-gold" id="btn-generic-pair" onclick="pairGenericDevice()">
            Pair Device (Reduced Trust)
          </button>
        </div>

        <!-- Generic Attestation Result -->
        <div class="card" id="generic-attestation-card" style="display:none">
          <div class="card-header">
            <div class="card-icon gold">‚ö†</div>
            <div>
              <div class="card-title">Local-Only Pairing Issued</div>
              <div class="card-desc">Client linked without on-chain attestation</div>
            </div>
          </div>

          <!-- Pairing Timeline (generic) -->
          <div class="timeline">
            <div class="timeline-step done">
              <div class="timeline-num">‚úì</div>
              <div class="timeline-body">
                <div class="timeline-title">Device Identified</div>
                <div class="timeline-desc" id="generic-attest-device-desc">‚Äî</div>
              </div>
            </div>
            <div class="timeline-step" style="opacity: 0.35;">
              <div class="timeline-num">‚Äî</div>
              <div class="timeline-body">
                <div class="timeline-title" style="color: var(--steel); text-decoration: line-through;">Genesis Token Verified</div>
                <div class="timeline-desc">Skipped ‚Äî no soulbound NFT on generic device.</div>
              </div>
            </div>
            <div class="timeline-step" style="opacity: 0.35;">
              <div class="timeline-num">‚Äî</div>
              <div class="timeline-body">
                <div class="timeline-title" style="color: var(--steel); text-decoration: line-through;">SAS Attestation Published</div>
                <div class="timeline-desc">Skipped ‚Äî no device identity anchor for on-chain credential.</div>
              </div>
            </div>
            <div class="timeline-step done">
              <div class="timeline-num">‚úì</div>
              <div class="timeline-body">
                <div class="timeline-title">BroadcastChannel Bridge Active</div>
                <div class="timeline-desc">AlpenSign notified ‚Äî payment requests will be delivered via browser channel.</div>
              </div>
            </div>
          </div>

          <div class="generic-attestation-card">
            <div class="attestation-header">
              <span class="generic-attestation-badge">Local Pairing</span>
              <span class="attestation-schema">No on-chain record</span>
            </div>
            <div class="kv-table">
              <div class="kv-row">
                <div class="kv-key">Mode</div>
                <div class="kv-val" style="color: var(--orange);">Reduced Trust (Generic Device)</div>
              </div>
              <div class="kv-row">
                <div class="kv-key">Device</div>
                <div class="kv-val" id="generic-attest-device">‚Äî</div>
              </div>
              <div class="kv-row">
                <div class="kv-key">Client</div>
                <div class="kv-val">Roman Koivu ¬∑ KB-2026-004871</div>
              </div>
              <div class="kv-row">
                <div class="kv-key">Timestamp</div>
                <div class="kv-val mono" id="generic-attest-timestamp" style="font-size:10px">‚Äî</div>
              </div>
              <div class="kv-row">
                <div class="kv-key">Genesis Token</div>
                <div class="kv-val" style="color: var(--orange);">N/A ‚Äî no Seeker hardware</div>
              </div>
              <div class="kv-row">
                <div class="kv-key">SAS Attestation</div>
                <div class="kv-val" style="color: var(--orange);">N/A ‚Äî no on-chain credential</div>
              </div>
              <div class="kv-row">
                <div class="kv-key">Solana TX</div>
                <div class="kv-val" style="color: var(--orange);">N/A ‚Äî local only</div>
              </div>
              <div class="kv-row">
                <div class="kv-key">Status</div>
                <div class="kv-val" style="color: var(--orange); font-weight: 700;">ACTIVE (LOCAL ONLY)</div>
              </div>
            </div>
          </div>

          <div style="margin-top: 16px">
            <button class="btn btn-outline" onclick="switchTab('payment')">
              Proceed to SIC Payment ‚Üí
            </button>
          </div>

          <div style="margin-top: 10px">
            <button class="btn btn-danger" onclick="revokeGenericPairing()">
              Remove Pairing
            </button>
          </div>
        </div>

      </div>

      <!-- ‚ïê‚ïê‚ïê SEEKER DEVICE PAIRING ‚ïê‚ïê‚ïê -->
      <div id="seeker-pairing">

      <!-- Seeker ID Input -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon blue">üì±</div>
          <div>
            <div class="card-title">Link Seeker Device</div>
            <div class="card-desc">Enter the client's .skr Seeker ID to bind their device</div>
          </div>
        </div>

        <div class="field">
          <span class="field-label">Seeker ID</span>
          <input type="text" class="field-input mono" id="skr-input" 
                 placeholder="redpill.skr" 
                 autocapitalize="none" autocorrect="off" spellcheck="false">
          <div class="field-hint">The client's .skr domain registered on their Seeker phone</div>
          <div class="field-error" id="skr-error" style="display:none"></div>
        </div>

        <button class="btn btn-gold" id="btn-resolve" onclick="resolveSeekerId()">
          Resolve Seeker ID
        </button>
      </div>

      <!-- Resolution Result (hidden initially) -->
      <div class="card" id="resolution-card" style="display:none">
        <div class="card-header">
          <div class="card-icon green">üîç</div>
          <div>
            <div class="card-title">Resolved Identity</div>
            <div class="card-desc">On-chain data for this Seeker ID</div>
          </div>
        </div>

        <div class="field">
          <span class="field-label">Seeker ID</span>
          <div class="field-static mono" id="resolved-skr">‚Äî</div>
        </div>

        <div class="field">
          <span class="field-label">Solana Address (Seed Vault)</span>
          <div class="field-static mono" id="resolved-address">‚Äî</div>
        </div>

        <div class="status-row">
          <div class="status-dot" id="genesis-dot"></div>
          <span class="status-label">Genesis Token</span>
          <span class="status-value" id="genesis-status">‚Äî</span>
        </div>

        <div class="status-row">
          <div class="status-dot" id="guardian-dot"></div>
          <span class="status-label">TEEPIN Guardian</span>
          <span class="status-value" id="guardian-status">‚Äî</span>
        </div>

        <div class="status-row">
          <div class="status-dot" id="skr-stake-dot"></div>
          <span class="status-label">SKR Staked</span>
          <span class="status-value" id="skr-stake-status">‚Äî</span>
        </div>
      </div>

      <!-- Challenge Signing -->
      <div class="card" id="challenge-card" style="display:none">
        <div class="card-header">
          <div class="card-icon gold">üîê</div>
          <div>
            <div class="card-title">Proof of Device Possession</div>
            <div class="card-desc">Client must sign this challenge with their Seeker's Seed Vault</div>
          </div>
        </div>

        <div class="challenge-box">
          <div class="challenge-label">Challenge String</div>
          <div class="challenge-string" id="challenge-text">‚Äî</div>
          <div class="challenge-hint">The client opens AlpenSign on their Seeker ‚Üí enters this string ‚Üí signs with Seed Vault biometric confirmation</div>
        </div>

        <div class="field-hint" style="margin: 12px 0 0; text-align:center">
          ‚è± Expires in <span id="challenge-timer">300</span>s
        </div>

        <div class="divider"></div>

        <!-- Signature Verification -->
        <div class="field">
          <span class="field-label">Client's Seed Vault Signature</span>
          <input type="text" class="field-input mono" id="sig-input"
                 placeholder="Paste signature from client's AlpenSign app"
                 autocapitalize="none" autocorrect="off" spellcheck="false"
                 style="font-size: 11px;">
          <div class="field-hint">The client reads or copies the signature from AlpenSign and provides it here</div>
        </div>

        <button class="btn btn-gold" id="btn-verify-challenge" onclick="verifyChallenge()">
          Verify Signature & Issue Attestation
        </button>

        <div class="divider" style="margin: 12px 0"></div>

        <button class="btn btn-outline" onclick="simulateVerifyChallenge()" style="font-size: 12px; padding: 10px; opacity: 0.6;">
          Skip: Simulate Verification ‚Üí
        </button>
      </div>

      <!-- Attestation Result -->
      <div class="card" id="attestation-card" style="display:none">
        <div class="card-header">
          <div class="card-icon green">‚úì</div>
          <div>
            <div class="card-title">Solana Attestation Issued</div>
            <div class="card-desc">Bank credential bound to verified Seeker device</div>
          </div>
        </div>

        <!-- Pairing Timeline -->
        <div class="timeline">
          <div class="timeline-step done">
            <div class="timeline-num">‚úì</div>
            <div class="timeline-body">
              <div class="timeline-title">Seeker ID Resolved</div>
              <div class="timeline-desc" id="attest-step1-desc">‚Äî</div>
            </div>
          </div>
          <div class="timeline-step done">
            <div class="timeline-num">‚úì</div>
            <div class="timeline-body">
              <div class="timeline-title">Genesis Token Verified</div>
              <div class="timeline-desc">Soulbound NFT confirmed on wallet. Device is genuine Seeker hardware.</div>
            </div>
          </div>
          <div class="timeline-step done">
            <div class="timeline-num">‚úì</div>
            <div class="timeline-body">
              <div class="timeline-title">Challenge Signed</div>
              <div class="timeline-desc">Client proved device possession via Seed Vault biometric signature.</div>
            </div>
          </div>
          <div class="timeline-step done">
            <div class="timeline-num">‚úì</div>
            <div class="timeline-body">
              <div class="timeline-title">SAS Attestation Published</div>
              <div class="timeline-desc">Bank credential posted to Solana via Attestation Service.</div>
            </div>
          </div>
        </div>

        <!-- Attestation Details -->
        <div class="attestation-card">
          <div class="attestation-header">
            <span class="attestation-badge">SAS Attestation</span>
            <span class="attestation-schema">v1.0 ¬∑ ISO 20022 aligned</span>
          </div>
          <div class="kv-table">
            <div class="kv-row">
              <div class="kv-key">Schema</div>
              <div class="kv-val mono">alpensign:bank-credential:v1</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Issuer</div>
              <div class="kv-val">Big Bank 123 (BBKZCHZZ)</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Contract</div>
              <div class="kv-val mono">KB-2026-004871</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Device</div>
              <div class="kv-val mono" id="attest-device">‚Äî</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Wallet</div>
              <div class="kv-val mono" id="attest-wallet" style="font-size:10px">‚Äî</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Issued</div>
              <div class="kv-val" id="attest-timestamp">‚Äî</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Expires</div>
              <div class="kv-val" id="attest-expiry">‚Äî</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">TX</div>
              <div class="kv-val mono" id="attest-tx" style="font-size:10px">‚Äî</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Status</div>
              <div class="kv-val green" style="font-weight:700">ACTIVE</div>
            </div>
          </div>
        </div>

        <div style="margin-top: 16px">
          <button class="btn btn-outline" onclick="switchTab('payment')">
            Proceed to SIC Payment ‚Üí
          </button>
        </div>

        <div style="margin-top: 10px">
          <button class="btn btn-danger" onclick="revokeAttestation()">
            Revoke Attestation
          </button>
        </div>
      </div>

      </div> <!-- end #seeker-pairing -->

    </div>

    <!-- ‚ïê‚ïê‚ïê PAYMENT VIEW ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-payment">

      <!-- Pre-check -->
      <div id="payment-precheck" style="display:none">
        <div class="card">
          <div class="card-header">
            <div class="card-icon red">‚ö†</div>
            <div>
              <div class="card-title">Device Not Paired</div>
              <div class="card-desc">Complete device pairing first to enable AlpenSign-sealed payments.</div>
            </div>
          </div>
          <button class="btn btn-outline" onclick="switchTab('pairing')">‚Üê Go to Pairing</button>
        </div>
      </div>

      <!-- Payment form -->
      <div id="payment-form">

        <div class="card">
          <div class="card-header">
            <div class="card-icon blue">üí∏</div>
            <div>
              <div class="card-title">SIC CHF Payment</div>
              <div class="card-desc">High-value real-time gross settlement via Swiss Interbank Clearing</div>
            </div>
          </div>

          <div class="field">
            <span class="field-label">Debtor</span>
            <div class="field-static">Roman Koivu ¬∑ CH93 0076 2011 6238 5295 7</div>
          </div>

          <div class="divider"></div>

          <div class="field">
            <span class="field-label">Creditor Name</span>
            <input type="text" class="field-input" id="pay-creditor" value="M√ºller Maschinenbau AG" placeholder="Creditor name">
          </div>

          <div class="field">
            <span class="field-label">Creditor IBAN</span>
            <input type="text" class="field-input mono" id="pay-iban" value="CH56 0483 5012 3456 7800 9" placeholder="CH__ ____ ____ ____ ____ _" autocapitalize="none">
          </div>

          <div class="field">
            <span class="field-label">Creditor Address</span>
            <input type="text" class="field-input" id="pay-address" value="Industriestrasse 42, 8005 Z√ºrich" placeholder="Street, PLZ City">
          </div>

          <div class="divider"></div>

          <div class="field">
            <span class="field-label">Amount (CHF)</span>
            <input type="text" class="field-input" id="pay-amount" value="2'450'000.00" placeholder="0.00" inputmode="decimal" style="font-size:22px; font-weight:700; text-align:right">
          </div>

          <div class="field">
            <span class="field-label">Payment Reference</span>
            <input type="text" class="field-input mono" id="pay-reference" value="RF48 5021 0000 0003 8735 1" placeholder="QR Reference or SCOR" autocapitalize="none">
          </div>

          <div class="field">
            <span class="field-label">Value Date</span>
            <input type="date" class="field-input" id="pay-date" style="color: var(--white);">
          </div>

          <div class="field" style="margin-bottom:0">
            <span class="field-label">Remittance Info</span>
            <input type="text" class="field-input" id="pay-info" value="Rechnung Nr. 2026-0389 / Werkzeugmaschine CNC-450" placeholder="Unstructured info">
          </div>
        </div>

        <!-- SIC Details -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon gold">‚ö°</div>
            <div>
              <div class="card-title">SIC Settlement Details</div>
              <div class="card-desc">RTGS processing via SIX Interbank Clearing</div>
            </div>
          </div>

          <div class="status-row">
            <div class="status-dot active"></div>
            <span class="status-label">Settlement</span>
            <span class="status-value green">Real-time (RTGS)</span>
          </div>
          <div class="status-row">
            <div class="status-dot active"></div>
            <span class="status-label">Currency</span>
            <span class="status-value green">CHF</span>
          </div>
          <div class="status-row">
            <div class="status-dot active"></div>
            <span class="status-label">Message Standard</span>
            <span class="status-value green">ISO 20022 pacs.008</span>
          </div>
          <div class="status-row">
            <div class="status-dot pending"></div>
            <span class="status-label">AlpenSign Seal</span>
            <span class="status-value orange" id="payment-seal-status">Required</span>
          </div>
        </div>

        <!-- Send Button -->
        <button class="btn btn-send" id="btn-send-payment" onclick="sendPayment()">
          Send to Client for AlpenSign Seal
        </button>

        <div class="field-hint" style="text-align: center; margin-top: 10px">
          Payment will be held pending until the client seals it via AlpenSign on their device.
        </div>

      </div>

      <!-- Pending Seal State -->
      <div id="payment-pending" style="display:none">
        <div class="card">
          <div class="payment-hero">
            <div class="payment-type-badge sic">SIC RTGS ¬∑ CHF</div>
            <div class="payment-amount" style="margin-top:12px">
              <span class="payment-currency">CHF </span><span id="pending-amount">2'450'000.00</span>
            </div>
          </div>

          <div class="kv-table">
            <div class="kv-row">
              <div class="kv-key">Creditor</div>
              <div class="kv-val" id="pending-creditor">‚Äî</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">IBAN</div>
              <div class="kv-val mono" id="pending-iban">‚Äî</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Reference</div>
              <div class="kv-val mono" id="pending-ref">‚Äî</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Value Date</div>
              <div class="kv-val" id="pending-date">‚Äî</div>
            </div>
          </div>
        </div>

        <!-- Seal Status -->
        <div class="seal-banner waiting" id="seal-waiting-banner">
          <div class="spinner green"></div>
          <div class="seal-banner-text">
            Waiting for client to seal this payment via AlpenSign‚Ä¶
          </div>
        </div>

        <div class="seal-banner sealed" id="seal-done-banner" style="display:none">
          <div class="seal-banner-icon">‚úì</div>
          <div class="seal-banner-text" id="seal-done-text">
            Payment sealed by client. Immutable proof on Solana. SIC settlement initiated.
          </div>
        </div>

        <!-- Simulate seal button -->
        <button class="btn btn-outline" id="btn-sim-seal" onclick="simulateSeal()" style="margin-bottom:12px">
          Simulate: Client Sealed via AlpenSign ‚úì
        </button>

        <!-- Seal Proof (hidden until sealed) -->
        <div class="card" id="seal-proof-card" style="display:none">
          <div class="card-header">
            <div class="card-icon green">üîè</div>
            <div>
              <div class="card-title">AlpenSign Seal Proof</div>
              <div class="card-desc">Independent evidence ‚Äî not controlled by the bank</div>
            </div>
          </div>

          <div class="kv-table">
            <div class="kv-row">
              <div class="kv-key">Seal Hash</div>
              <div class="kv-val mono" id="seal-hash" style="font-size:10px">‚Äî</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Device</div>
              <div class="kv-val">Solana Seeker ¬∑ Seed Vault</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Auth Method</div>
              <div class="kv-val">BIOMETRIC_HARDWARE</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Auth Channel</div>
              <div class="kv-val">INDEPENDENT_DEVICE</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Solana TX</div>
              <div class="kv-val mono" id="seal-solana-tx" style="font-size:10px">‚Äî</div>
            </div>
            <div class="kv-row">
              <div class="kv-key">Sealed At</div>
              <div class="kv-val" id="seal-timestamp">‚Äî</div>
            </div>
          </div>

          <div style="margin-top:14px">
            <a href="#" class="btn btn-outline" id="seal-explorer-link" target="_blank" style="text-decoration:none">
              üîó View on Solana Explorer
            </a>
          </div>
        </div>

        <!-- SIC Status -->
        <div class="card" id="sic-status-card" style="display:none">
          <div class="card-header">
            <div class="card-icon green">‚ö°</div>
            <div>
              <div class="card-title">SIC Settlement</div>
              <div class="card-desc">Real-time gross settlement confirmed</div>
            </div>
          </div>

          <div class="status-row">
            <div class="status-dot active"></div>
            <span class="status-label">SIC Status</span>
            <span class="status-value green">SETTLED</span>
          </div>
          <div class="status-row">
            <div class="status-dot active"></div>
            <span class="status-label">AlpenSign Seal</span>
            <span class="status-value green">VERIFIED</span>
          </div>
          <div class="status-row">
            <div class="status-dot active"></div>
            <span class="status-label">Finality</span>
            <span class="status-value green">IRREVOCABLE</span>
          </div>
        </div>

        <button class="btn btn-outline" onclick="resetPayment()" style="margin-top:4px">
          New Payment
        </button>
      </div>

    </div>

  </div>

  <!-- FOOTER -->
  <div class="footer">
    Big Bank 123 ¬∑ Demo Environment ¬∑ <a href="https://alpensign.com" target="_blank">alpensign.com</a> ¬∑ Solana Devnet
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
const state = {
  paired: false,
  pairingMode: null,    // 'seeker' or 'generic'
  genericDevice: null,  // device name for generic pairing
  seekerId: null,
  solanaAddress: null,
  challenge: null,
  attestationTx: null,
  paymentSent: false,
  paymentSealed: false,
};

// ‚ïê‚ïê‚ïê SIMULATED DATA ‚ïê‚ïê‚ïê
const SIMULATED_ADDRESSES = {
  'redpill.skr': '7xKJf4bN8mQ2kLpR9vAeW3nYhD6cTzXs5uGm1FjHq8ZV',
  'roman.skr': '9aHDx5vKp3zR8nLwQ2mYbJ7cGtF4sXeU6jWk1rNhT0CV',
  'alpensign.skr': '4pRkG8dXn2mL5vYwQ7jHbC1fTzAe9sKu3xNh6WFJM0ZV',
  'koivu.skr': '3bNmK7fXq8pL2wYvR5jHdC4gTzAe1sKu6xNh9WFJM0ZV',
};

function generateAddress() {
  const chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
  let addr = '';
  for (let i = 0; i < 44; i++) addr += chars[Math.floor(Math.random() * chars.length)];
  return addr;
}

function generateTxSig() {
  const chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
  let sig = '';
  for (let i = 0; i < 88; i++) sig += chars[Math.floor(Math.random() * chars.length)];
  return sig;
}

function generateChallenge() {
  const hex = '0123456789abcdef';
  let c = 'BB123-';
  for (let i = 0; i < 8; i++) c += hex[Math.floor(Math.random() * 16)];
  return c.toUpperCase();
}

async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// ‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(`view-${tab}`).classList.add('active');

  if (tab === 'payment') {
    updatePaymentView();
  }

  // Scroll to top
  document.querySelector('.content').scrollTop = 0;
}

function updatePaymentView() {
  const precheck = document.getElementById('payment-precheck');
  const form = document.getElementById('payment-form');
  const pending = document.getElementById('payment-pending');

  if (state.paymentSent) {
    precheck.style.display = 'none';
    form.style.display = 'none';
    pending.style.display = 'block';
  } else if (!state.paired) {
    precheck.style.display = 'block';
    form.style.display = 'none';
    pending.style.display = 'none';
  } else {
    precheck.style.display = 'none';
    form.style.display = 'block';
    pending.style.display = 'none';
  }
}

// ‚ïê‚ïê‚ïê BROADCASTCHANNEL ‚Äî AlpenSign Bridge ‚ïê‚ïê‚ïê
const alpensignChannel = new BroadcastChannel('alpensign-bank-bridge');

alpensignChannel.onmessage = (event) => {
  const msg = event.data;
  console.log('[BankBridge] Received:', msg.type);

  if (msg.type === 'seal-complete') {
    // AlpenSign completed a seal ‚Äî update payment UI
    handleSealFromAlpenSign(msg.seal);
  }
};

async function handleSealFromAlpenSign(seal) {
  if (!state.paymentSent || state.paymentSealed) return;

  document.getElementById('seal-hash').textContent = seal.hash || '‚Äî';
  document.getElementById('seal-solana-tx').textContent = seal.solanaTx
    ? seal.solanaTx.slice(0, 44) + '‚Ä¶'
    : '‚Äî (local)';
  document.getElementById('seal-timestamp').textContent = new Date(seal.timestamp).toISOString().replace('T', ' ').slice(0, 19) + ' UTC';
  if (seal.solanaTx && seal.solanaTxReal) {
    document.getElementById('seal-explorer-link').href = `https://explorer.solana.com/tx/${seal.solanaTx}?cluster=devnet`;
  }

  // Update banners
  document.getElementById('seal-waiting-banner').style.display = 'none';
  document.getElementById('seal-done-banner').style.display = 'flex';
  document.getElementById('btn-sim-seal').style.display = 'none';

  document.getElementById('seal-proof-card').style.display = 'block';

  await sleep(500);
  document.getElementById('sic-status-card').style.display = 'block';

  document.getElementById('payment-seal-status').textContent = 'Verified ‚úì';
  document.getElementById('payment-seal-status').className = 'status-value green';

  state.paymentSealed = true;

  document.getElementById('seal-proof-card').scrollIntoView({ behavior: 'smooth', block: 'start' });

  const isGeneric = state.pairingMode === 'generic';
  toast(isGeneric
    ? '‚ö† AlpenSign seal received (local proof only)'
    : '‚úì AlpenSign seal received from Seeker'
  );
  if (isGeneric) {
    document.getElementById('seal-done-text').textContent =
      'Payment sealed by client. Local cryptographic proof only ‚Äî no on-chain record.';
  }
}

// Send attestation confirmation to AlpenSign
function sendAttestationToAlpenSign() {
  alpensignChannel.postMessage({
    type: 'attestation-confirmed',
    contract: 'KB-2026-004871',
    bank: 'Big Bank 123',
    seekerId: state.seekerId,
    solanaAddress: state.solanaAddress,
  });
  console.log('[BankBridge] Attestation confirmation sent to AlpenSign');
}

// ‚ïê‚ïê‚ïê VERIFY CHALLENGE (real signature pasted) ‚ïê‚ïê‚ïê
async function verifyChallenge() {
  const sigInput = document.getElementById('sig-input');
  const sig = sigInput.value.trim();

  if (!sig || sig.length < 20) {
    sigInput.classList.add('error');
    toast('Paste the signature from the client\'s AlpenSign app');
    return;
  }

  sigInput.classList.remove('error');

  const btn = document.getElementById('btn-verify-challenge');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner green"></div> Verifying Seed Vault signature‚Ä¶';

  await sleep(2000);
  clearInterval(challengeInterval);

  // In production: cryptographically verify the signature against the challenge + public key
  // For demo: accept any non-trivial input
  await completeAttestation();

  btn.innerHTML = 'Verify Signature & Issue Attestation';
  btn.disabled = false;
}
// ‚ïê‚ïê‚ïê PAIRING MODE SWITCH ‚ïê‚ïê‚ïê
function switchPairingMode(mode) {
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.mode-btn[data-mode="${mode}"]`).classList.add('active');

  document.getElementById('seeker-pairing').style.display = mode === 'seeker' ? 'block' : 'none';
  document.getElementById('generic-pairing').style.display = mode === 'generic' ? 'block' : 'none';
}

// ‚ïê‚ïê‚ïê GENERIC DEVICE PAIRING ‚ïê‚ïê‚ïê
async function pairGenericDevice() {
  const input = document.getElementById('generic-device-input');
  const errEl = document.getElementById('generic-device-error');
  const val = input.value.trim();

  if (!val || val.length < 2) {
    input.classList.add('error');
    errEl.textContent = 'Please enter a device name (e.g. Pixel 8a)';
    errEl.style.display = 'block';
    return;
  }

  input.classList.remove('error');
  errEl.style.display = 'none';

  const btn = document.getElementById('btn-generic-pair');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Registering device‚Ä¶';

  await sleep(1200);

  const now = new Date();
  state.paired = true;
  state.pairingMode = 'generic';
  state.genericDevice = val;

  // Fill attestation card
  document.getElementById('generic-attest-device-desc').textContent =
    `${val} ‚Üí WebAuthn platform key (local only)`;
  document.getElementById('generic-attest-device').textContent = val;
  document.getElementById('generic-attest-timestamp').textContent =
    now.toISOString().replace('T', ' ').slice(0, 19) + ' UTC';

  document.getElementById('generic-attestation-card').style.display = 'block';

  // Notify AlpenSign via BroadcastChannel
  alpensignChannel.postMessage({
    type: 'attestation-confirmed',
    contract: 'KB-2026-004871',
    bank: 'Big Bank 123',
    device: val,
    mode: 'generic',
  });
  console.log('[BankBridge] Generic attestation sent to AlpenSign');

  document.getElementById('generic-attestation-card').scrollIntoView({ behavior: 'smooth', block: 'start' });

  btn.disabled = false;
  btn.innerHTML = 'Pair Device (Reduced Trust)';

  toast('‚ö† Device paired (local only ‚Äî reduced trust)');
}

// ‚ïê‚ïê‚ïê REVOKE GENERIC PAIRING ‚ïê‚ïê‚ïê
function revokeGenericPairing() {
  if (!confirm('Remove the local pairing for this client? This will disable AlpenSign sealing.')) return;

  state.paired = false;
  state.pairingMode = null;
  state.genericDevice = null;
  state.paymentSent = false;
  state.paymentSealed = false;

  document.getElementById('generic-attestation-card').style.display = 'none';
  document.getElementById('generic-device-input').value = '';

  toast('Pairing removed');
}

// ‚ïê‚ïê‚ïê RESOLVE SEEKER ID ‚ïê‚ïê‚ïê
async function resolveSeekerId() {
  const input = document.getElementById('skr-input');
  const errEl = document.getElementById('skr-error');
  let val = input.value.trim().toLowerCase();

  // Auto-append .skr
  if (val && !val.endsWith('.skr')) val += '.skr';

  // Validate
  if (!val || val === '.skr') {
    input.classList.add('error');
    errEl.textContent = 'Please enter a valid Seeker ID';
    errEl.style.display = 'block';
    return;
  }

  if (!/^[a-z0-9_-]+\.skr$/.test(val)) {
    input.classList.add('error');
    errEl.textContent = 'Invalid format. Use letters, numbers, hyphens only.';
    errEl.style.display = 'block';
    return;
  }

  input.classList.remove('error');
  errEl.style.display = 'none';
  input.value = val;

  // Simulate resolution
  const btn = document.getElementById('btn-resolve');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Resolving on Solana‚Ä¶';

  await sleep(1500);

  const address = SIMULATED_ADDRESSES[val] || generateAddress();
  state.seekerId = val;
  state.solanaAddress = address;

  // Show resolution
  document.getElementById('resolved-skr').textContent = val;
  document.getElementById('resolved-address').textContent = address;

  // Genesis token
  document.getElementById('genesis-dot').className = 'status-dot active';
  document.getElementById('genesis-status').className = 'status-value green';
  document.getElementById('genesis-status').textContent = 'Verified ‚úì';

  // Guardian
  document.getElementById('guardian-dot').className = 'status-dot active';
  document.getElementById('guardian-status').className = 'status-value green';
  document.getElementById('guardian-status').textContent = 'Helius';

  // SKR Stake
  document.getElementById('skr-stake-dot').className = 'status-dot active';
  document.getElementById('skr-stake-status').className = 'status-value green';
  document.getElementById('skr-stake-status').textContent = '42,500 SKR';

  document.getElementById('resolution-card').style.display = 'block';

  await sleep(300);

  // Generate challenge
  state.challenge = generateChallenge();
  document.getElementById('challenge-text').textContent = state.challenge;
  document.getElementById('challenge-card').style.display = 'block';

  // Start timer
  startChallengeTimer();

  btn.disabled = false;
  btn.innerHTML = 'Resolve Seeker ID';

  // Scroll to resolution
  document.getElementById('resolution-card').scrollIntoView({ behavior: 'smooth', block: 'start' });

  toast('Seeker ID resolved ¬∑ Challenge generated');
}

let challengeInterval;
function startChallengeTimer() {
  let seconds = 300;
  const el = document.getElementById('challenge-timer');
  clearInterval(challengeInterval);
  challengeInterval = setInterval(() => {
    seconds--;
    el.textContent = seconds;
    if (seconds <= 0) clearInterval(challengeInterval);
  }, 1000);
}

// ‚ïê‚ïê‚ïê VERIFY CHALLENGE (simulated) ‚ïê‚ïê‚ïê
async function simulateVerifyChallenge() {
  const btn = document.querySelector('#challenge-card .btn-outline:last-child');
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner green"></div> Simulating‚Ä¶';
  }

  await sleep(1500);
  clearInterval(challengeInterval);

  await completeAttestation();

  if (btn) {
    btn.innerHTML = 'Skip: Simulate Verification ‚Üí';
    btn.disabled = false;
  }
}

// ‚ïê‚ïê‚ïê COMPLETE ATTESTATION (shared by verify + simulate) ‚ïê‚ïê‚ïê
async function completeAttestation() {
  // Generate attestation TX
  state.attestationTx = generateTxSig();
  state.paired = true;
  state.pairingMode = 'seeker';

  const now = new Date();
  const expiry = new Date(now);
  expiry.setFullYear(expiry.getFullYear() + 1);

  // Fill attestation card
  document.getElementById('attest-step1-desc').textContent =
    `${state.seekerId} ‚Üí ${state.solanaAddress.slice(0, 8)}‚Ä¶${state.solanaAddress.slice(-4)}`;
  document.getElementById('attest-device').textContent = state.seekerId;
  document.getElementById('attest-wallet').textContent = state.solanaAddress;
  document.getElementById('attest-timestamp').textContent = now.toISOString().replace('T', ' ').slice(0, 19) + ' UTC';
  document.getElementById('attest-expiry').textContent = expiry.toISOString().slice(0, 10);
  document.getElementById('attest-tx').textContent = state.attestationTx.slice(0, 44) + '‚Ä¶';

  document.getElementById('attestation-card').style.display = 'block';

  // Notify AlpenSign via BroadcastChannel
  sendAttestationToAlpenSign();

  // Scroll to attestation
  document.getElementById('attestation-card').scrollIntoView({ behavior: 'smooth', block: 'start' });

  toast('‚úì Attestation issued ¬∑ AlpenSign notified');
}

// ‚ïê‚ïê‚ïê REVOKE ‚ïê‚ïê‚ïê
async function revokeAttestation() {
  if (!confirm('Revoke the SAS attestation for this client? This will deactivate AlpenSign sealing.')) return;

  state.paired = false;
  state.pairingMode = null;
  state.seekerId = null;
  state.solanaAddress = null;
  state.attestationTx = null;
  state.paymentSent = false;
  state.paymentSealed = false;

  document.getElementById('resolution-card').style.display = 'none';
  document.getElementById('challenge-card').style.display = 'none';
  document.getElementById('attestation-card').style.display = 'none';
  document.getElementById('skr-input').value = '';

  toast('Attestation revoked');
}

// ‚ïê‚ïê‚ïê SEND PAYMENT ‚ïê‚ïê‚ïê
async function sendPayment() {
  const btn = document.getElementById('btn-send-payment');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner green"></div> Submitting to SIC‚Ä¶';

  const creditor = document.getElementById('pay-creditor').value;
  const iban = document.getElementById('pay-iban').value;
  const amount = document.getElementById('pay-amount').value;
  const ref = document.getElementById('pay-reference').value;
  const date = document.getElementById('pay-date').value || new Date().toISOString().slice(0, 10);

  await sleep(1500);

  // Populate pending view
  document.getElementById('pending-amount').textContent = amount;
  document.getElementById('pending-creditor').textContent = creditor;
  document.getElementById('pending-iban').textContent = iban;
  document.getElementById('pending-ref').textContent = ref;
  document.getElementById('pending-date').textContent = date;

  // Send to AlpenSign via BroadcastChannel
  const requestId = 'PAY-' + Date.now();
  alpensignChannel.postMessage({
    type: 'payment-request',
    requestId,
    payment: {
      creditor,
      iban,
      amount,
      reference: ref,
      date,
      address: document.getElementById('pay-address').value,
      info: document.getElementById('pay-info').value,
    },
  });
  console.log('[BankBridge] Payment request sent to AlpenSign');

  state.paymentSent = true;
  state.paymentSealed = false;

  // Reset seal UI
  document.getElementById('seal-waiting-banner').style.display = 'flex';
  document.getElementById('seal-done-banner').style.display = 'none';
  document.getElementById('btn-sim-seal').style.display = 'block';
  document.getElementById('seal-proof-card').style.display = 'none';
  document.getElementById('sic-status-card').style.display = 'none';

  updatePaymentView();

  btn.disabled = false;
  btn.innerHTML = 'Send to Client for AlpenSign Seal';

  toast('Payment sent ¬∑ Waiting for AlpenSign seal');
}

// ‚ïê‚ïê‚ïê SIMULATE SEAL ‚ïê‚ïê‚ïê
async function simulateSeal() {
  const btn = document.getElementById('btn-sim-seal');
  btn.disabled = true;
  btn.innerHTML = state.pairingMode === 'generic'
    ? '<div class="spinner green"></div> Client sealing with WebAuthn‚Ä¶'
    : '<div class="spinner green"></div> Client sealing with Seeker‚Ä¶';

  await sleep(2500);

  const paymentData = [
    document.getElementById('pending-creditor').textContent,
    document.getElementById('pending-iban').textContent,
    document.getElementById('pending-amount').textContent,
    document.getElementById('pending-ref').textContent,
  ].join('|');

  const hash = await sha256(paymentData);
  const txSig = generateTxSig();
  const now = new Date();

  document.getElementById('seal-hash').textContent = hash;
  document.getElementById('seal-solana-tx').textContent = txSig.slice(0, 44) + '‚Ä¶';
  document.getElementById('seal-timestamp').textContent = now.toISOString().replace('T', ' ').slice(0, 19) + ' UTC';
  document.getElementById('seal-explorer-link').href = `https://explorer.solana.com/tx/${txSig}?cluster=devnet`;

  // Update banners
  document.getElementById('seal-waiting-banner').style.display = 'none';
  document.getElementById('seal-done-banner').style.display = 'flex';
  btn.style.display = 'none';

  document.getElementById('seal-proof-card').style.display = 'block';

  await sleep(500);
  document.getElementById('sic-status-card').style.display = 'block';

  document.getElementById('payment-seal-status').textContent = 'Verified ‚úì';
  document.getElementById('payment-seal-status').className = 'status-value green';

  state.paymentSealed = true;

  document.getElementById('seal-proof-card').scrollIntoView({ behavior: 'smooth', block: 'start' });

  toast(state.pairingMode === 'generic'
    ? '‚ö† Payment sealed (local proof only ‚Äî no SIC settlement)'
    : '‚úì Payment sealed & SIC settlement initiated'
  );
}

// ‚ïê‚ïê‚ïê RESET PAYMENT ‚ïê‚ïê‚ïê
function resetPayment() {
  state.paymentSent = false;
  state.paymentSealed = false;

  document.getElementById('payment-seal-status').textContent = 'Required';
  document.getElementById('payment-seal-status').className = 'status-value orange';

  updatePaymentView();
  document.querySelector('.content').scrollTop = 0;
}

// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  // Set default date to today
  const today = new Date().toISOString().slice(0, 10);
  document.getElementById('pay-date').value = today;
});
</script>

</body>
</html>
